<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>桃園營運處-打卡系統</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Arial; padding: 22px; text-align: center; }
    h2 { margin: 0 0 14px; font-size: 22px; text-align: center; }

    .status{
      padding: 12px 14px; border-radius: 14px; margin: 0 auto 14px;
      font-size: 16px; line-height: 1.4; background: #f3f4f6;
      text-align: center; max-width: 520px;
    }
    .ok { background: #ecfdf5; }
    .bad { background: #fff1f2; }

    .btnCol{
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 520px;
      margin: 0 auto;
    }

    button{
      width: 100%;
      padding: 18px 12px;
      font-size: 22px;
      font-weight: 800;
      border: 0;
      border-radius: 16px;
      cursor: pointer;
      color: #fff;
      text-align: center;
    }

    /* 你指定的顏色 */
    #btnDispatch { background: #16a34a; } /* 綠：調度 */
    #btnLevel1  { background: #f97316; } /* 橘：一級 */
    #btnSwap    { background: #2563eb; } /* 藍：換電 */

    button:disabled { opacity: .45; cursor: not-allowed; }

    .done{
      position: fixed; inset: 0; display: none;
      align-items: center; justify-content: center;
      background: rgba(0,0,0,.45);
      text-align: center;
    }
    .done > div{
      background: #fff; padding: 18px 20px; border-radius: 16px;
      font-size: 20px; font-weight: 900;
      text-align: center; min-width: 220px;
    }
  </style>
</head>

<body>
  <h2>桃園營運處-打卡系統</h2>

  <div id="status" class="status">定位中…</div>

  <div class="btnCol">
    <button id="btnDispatch" disabled>調度打卡</button>
    <button id="btnLevel1" disabled>一級打卡</button>
    <button id="btnSwap" disabled>換電打卡</button>
  </div>

  <div class="done" id="done"><div>✅ 打卡完成</div></div>

<script>
  const LIFF_ID = "2009174277-dSY24pNu";
  const GAS_URL  = "https://script.google.com/macros/s/AKfycbyI1gsHWcdfnynjPyuJ55VRFLiwq74ULORIvRHHc94VA0PN673AVtWF6UC_0t5Ch_Ki/exec";

  const statusEl = document.getElementById("status");
  const btnDispatch = document.getElementById("btnDispatch");
  const btnLevel1 = document.getElementById("btnLevel1");
  const btnSwap = document.getElementById("btnSwap");
  const doneEl = document.getElementById("done");

  let profile = null;
  let lastPos = null;
  let canPunchNow = false;

  // ✅ 測試模式：網址帶 ?test=1&key=xxx
  const params = new URLSearchParams(location.search);
  const isTest = params.get("test") === "1";
  const testKey = (params.get("key") || "").trim(); // 會送去 GAS 判斷是否 bypass

  function setButtonsEnabled(on) {
    btnDispatch.disabled = !on;
    btnLevel1.disabled = !on;
    btnSwap.disabled = !on;
  }

  function setStatus(text, type) {
    statusEl.textContent = text;
    statusEl.classList.remove("ok", "bad");
    if (type) statusEl.classList.add(type);
  }

  function getLocation() {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) return reject(new Error("no geolocation"));
      navigator.geolocation.getCurrentPosition(
        (pos) => resolve(pos),
        (err) => reject(err),
        { enableHighAccuracy: true, timeout: 12000, maximumAge: 0 }
      );
    });
  }

  async function checkCanPunch() {
    try {
      const pos = await getLocation();
      lastPos = pos;
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      const url =
        `${GAS_URL}?action=check&lat=${encodeURIComponent(lat)}&lng=${encodeURIComponent(lng)}`
        + (testKey ? `&testKey=${encodeURIComponent(testKey)}` : "");

      const res = await fetch(url, { method: "GET" });
      const data = await res.json();

      if (!data.ok) throw new Error("check failed");

      if (data.canPunch) {
        canPunchNow = true;
        setButtonsEnabled(true);

        const extra = data.bypass ? "（測試模式：已略過距離）" : "";
        setStatus(`✅ 可打卡（${data.station} / ${data.distanceM}m）${extra}`, "ok");
      } else {
        canPunchNow = false;
        setButtonsEnabled(false);
        setStatus(`❌ 目前不可打卡（最近：${data.station} / ${data.distanceM}m，需 ≤ ${data.allowM}m）`, "bad");
      }
    } catch (e) {
      canPunchNow = false;
      setButtonsEnabled(false);
      setStatus("❌ 無法取得定位或檢查失敗，請開啟定位後重試", "bad");
    }
  }

  async function sendPunch(punchType) {
    if (!profile) return alert("尚未登入，請重新開啟");
    if (!lastPos) return alert("定位中，請稍等");
    if (!canPunchNow) return alert("目前不在可打卡範圍內");

    setButtonsEnabled(false);

    const lat = lastPos.coords.latitude;
    const lng = lastPos.coords.longitude;

    try {
      const payload = {
        userId: profile.userId,
        displayName: profile.displayName,
        punchType, // dispatch / level1 / swap
        lat, lng,
        ...(testKey ? { testKey } : {})
      };

      const res = await fetch(GAS_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload),
      });

      const text = await res.text();

      if (res.ok && String(text).startsWith("OK")) {
        doneEl.style.display = "flex";
        setTimeout(() => {
          try { liff.closeWindow(); } catch (_) {}
        }, 800);
      } else {
        alert("❌ 打卡失敗，請再試一次");
        setButtonsEnabled(true);
      }
    } catch (e) {
      alert("❌ 打卡失敗，請檢查網路後再試一次");
      setButtonsEnabled(true);
    }
  }

  btnDispatch.addEventListener("click", () => sendPunch("dispatch"));
  btnLevel1.addEventListener("click", () => sendPunch("level1"));
  btnSwap.addEventListener("click", () => sendPunch("swap"));

  async function init() {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) { liff.login(); return; }
    profile = await liff.getProfile();

    await checkCanPunch();
    setInterval(checkCanPunch, 10000);
  }

  init().catch(() => setStatus("❌ 初始化失敗，請重新開啟", "bad"));
</script>
</body>
</html>
