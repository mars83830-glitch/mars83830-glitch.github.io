<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>打卡</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Arial; padding: 22px; }
    h2 { margin: 0 0 14px; font-size: 22px; }
    .status {
      padding: 12px 14px; border-radius: 14px; margin-bottom: 14px;
      font-size: 16px; line-height: 1.4;
      background: #f3f4f6;
    }
    .ok { background: #ecfdf5; }
    .bad { background: #fff1f2; }

    button {
      width: 100%;
      padding: 18px 16px;
      margin: 12px 0;
      font-size: 22px;
      font-weight: 700;
      border: 0;
      border-radius: 16px;
      cursor: pointer;
      color: #fff;
    }
    #btnDispatch { background: #2563eb; } /* 藍 */
    #btnLevel1 { background: #f97316; }   /* 橘 */

    button:disabled { opacity: .45; cursor: not-allowed; }

    .done {
      position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
      background: rgba(0,0,0,.45);
    }
    .done > div {
      background: #fff; padding: 18px 20px; border-radius: 16px;
      font-size: 20px; font-weight: 800;
    }
  </style>
</head>
<body>
  <h2>打卡</h2>

  <div id="status" class="status">定位中…</div>

  <button id="btnDispatch" disabled>調度打卡</button>
  <button id="btnLevel1" disabled>一級打卡</button>

  <div class="done" id="done"><div>✅ 打卡完成</div></div>

<script>
  const LIFF_ID = "2009174277-dSY24pNu";
  const GAS_URL  = "https://script.google.com/macros/s/AKfycbyI1gsHWcdfnynjPyuJ55VRFLiwq74ULORIvRHHc94VA0PN673AVtWF6UC_0t5Ch_Ki/exec";

  const statusEl = document.getElementById("status");
  const btnDispatch = document.getElementById("btnDispatch");
  const btnLevel1 = document.getElementById("btnLevel1");
  const doneEl = document.getElementById("done");

  let profile = null;
  let lastPos = null;
  let canPunchNow = false;

  function setButtonsEnabled(on) {
    btnDispatch.disabled = !on;
    btnLevel1.disabled = !on;
  }

  function setStatus(text, type) {
    statusEl.textContent = text;
    statusEl.classList.remove("ok", "bad");
    if (type) statusEl.classList.add(type);
  }

  function getLocation() {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) return reject(new Error("no geolocation"));
      navigator.geolocation.getCurrentPosition(
        (pos) => resolve(pos),
        (err) => reject(err),
        { enableHighAccuracy: true, timeout: 12000, maximumAge: 0 }
      );
    });
  }

  async function checkCanPunch() {
    try {
      const pos = await getLocation();
      lastPos = pos;
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      const url = `${GAS_URL}?action=check&lat=${encodeURIComponent(lat)}&lng=${encodeURIComponent(lng)}`;
      const res = await fetch(url, { method: "GET" });
      const data = await res.json();

      if (!data.ok) throw new Error("check failed");

      if (data.canPunch) {
        canPunchNow = true;
        setButtonsEnabled(true);
        setStatus(`✅ 可打卡（${data.station} / ${data.distanceM}m）`, "ok");
      } else {
        canPunchNow = false;
        setButtonsEnabled(false);
        setStatus(`❌ 目前不可打卡（最近：${data.station} / ${data.distanceM}m，需 ≤ ${data.allowM}m）`, "bad");
      }
    } catch (e) {
      canPunchNow = false;
      setButtonsEnabled(false);
      setStatus("❌ 無法取得定位或檢查失敗，請開啟定位後重試", "bad");
    }
  }

  async function sendPunch(punchType) {
    if (!profile) return alert("尚未登入，請重新開啟");
    if (!lastPos) return alert("定位中，請稍等");
    if (!canPunchNow) return alert("目前不在可打卡範圍內");

    setButtonsEnabled(false);

    const lat = lastPos.coords.latitude;
    const lng = lastPos.coords.longitude;

    try {
      const payload = {
        userId: profile.userId,
        displayName: profile.displayName,
        punchType, // dispatch / level1
        lat, lng
      };

      const res = await fetch(GAS_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload),
      });

      const text = await res.text();

      if (res.ok && String(text).startsWith("OK")) {
        doneEl.style.display = "flex";
        setTimeout(() => {
          try { liff.closeWindow(); } catch (_) {}
        }, 800);
      } else {
        alert("❌ 打卡失敗，請再試一次");
        setButtonsEnabled(true);
      }
    } catch (e) {
      alert("❌ 打卡失敗，請檢查網路後再試一次");
      setButtonsEnabled(true);
    }
  }

  btnDispatch.addEventListener("click", () => sendPunch("dispatch"));
  btnLevel1.addEventListener("click", () => sendPunch("level1"));

  async function init() {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) { liff.login(); return; }
    profile = await liff.getProfile();

    await checkCanPunch();
    // 即時刷新（每 10 秒更新一次可否打卡）
    setInterval(checkCanPunch, 10000);
  }

  init().catch(() => setStatus("❌ 初始化失敗，請重新開啟", "bad"));
</script>
</body>
</html>
