<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>打卡</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Arial; padding: 24px; }
    h2 { margin: 0 0 16px; }
    button {
      width: 100%;
      padding: 14px 16px;
      margin: 10px 0;
      font-size: 18px;
      border: 0;
      border-radius: 12px;
      cursor: pointer;
    }
    .hint { margin-top: 12px; font-size: 14px; opacity: .7; }
    .disabled { opacity: .6; cursor: not-allowed; }
  </style>
</head>
<body>
  <h2>打卡</h2>

  <button id="btnDispatch">調度打卡</button>
  <button id="btnLevel1">一級打卡</button>

  <div class="hint" id="hint"></div>

  <script>
    const LIFF_ID = "2009174277-dSY24pNu";
    const GAS_URL  = "https://script.google.com/macros/s/AKfycbyI1gsHWcdfnynjPyuJ55VRFLiwq74ULORIvRHHc94VA0PN673AVtWF6UC_0t5Ch_Ki/exec";

    let profile = null;

    const hintEl = document.getElementById("hint");
    const btnDispatch = document.getElementById("btnDispatch");
    const btnLevel1 = document.getElementById("btnLevel1");

    function setBusy(busy) {
      [btnDispatch, btnLevel1].forEach(b => {
        b.disabled = busy;
        b.classList.toggle("disabled", busy);
      });
      hintEl.textContent = busy ? "送出中…" : "";
    }

    async function init() {
      await liff.init({ liffId: LIFF_ID });

      if (!liff.isLoggedIn()) {
        liff.login();
        return;
      }

      profile = await liff.getProfile();
    }

    async function sendPunch(punchType) {
      if (!profile) {
        alert("尚未登入 LINE，請重新開啟");
        return;
      }

      setBusy(true);

      try {
        const payload = {
          userId: profile.userId,
          displayName: profile.displayName,
          punchType
        };

        const res = await fetch(GAS_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify(payload),
        });

        const text = await res.text();

        if (res.ok && String(text).startsWith("OK")) {
          alert("✅ 打卡成功");
          // 你想要成功後自動關閉 LIFF 視窗就打開這行：
          // liff.closeWindow();
        } else {
          alert("❌ 打卡失敗，請再試一次");
        }

      } catch (err) {
        alert("❌ 打卡失敗，請檢查網路後再試一次");
      } finally {
        setBusy(false);
      }
    }

    btnDispatch.addEventListener("click", () => sendPunch("調度打卡"));
    btnLevel1.addEventListener("click", () => sendPunch("一級打卡"));

    init().catch(() => alert("初始化失敗，請重新開啟"));
  </script>
</body>
</html>
