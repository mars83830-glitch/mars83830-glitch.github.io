<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LIFF ä¸¦ç™¼æ¸¬è©¦</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Arial; padding: 16px; }
    button { padding: 10px 14px; margin-right: 8px; cursor: pointer; }
    #log { white-space: pre-wrap; background: #f6f6f6; padding: 12px; border-radius: 8px; }
    input { padding: 8px; width: 320px; max-width: 100%; }
  </style>
</head>
<body>
  <h2>LIFF â†’ GAS ä¸¦ç™¼å¯«å…¥æ¸¬è©¦</h2>

  <div style="margin: 10px 0;">
    <label>è¨Šæ¯å‰ç¶´ï¼š</label>
    <input id="prefix" value="lock-test" />
  </div>

  <div style="margin: 10px 0;">
    <button id="btnInit">Init LIFF</button>
    <button id="btnBurst">ä¸¦ç™¼é€å‡º 10 ç­†</button>
    <button id="btnClear">æ¸…ç©º log</button>
  </div>

  <div id="log"></div>

  <script>
    const LIFF_ID = "2009174277-dSY24pNu";
    const GAS_URL  = "https://script.google.com/macros/s/AKfycbyI1gsHWcdfnynjPyuJ55VRFLiwq74ULORIvRHHc94VA0PN673AVtWF6UC_0t5Ch_Ki/exec";

    const logEl = document.getElementById("log");
    const log = (m) => { logEl.textContent += m + "\n"; };

    let cachedProfile = null;

    async function initLiff() {
      await liff.init({ liffId: LIFF_ID });
      log("âœ… LIFF init OK");

      if (!liff.isLoggedIn()) {
        log("âš ï¸ Not logged in -> liff.login()");
        liff.login();
        return;
      }

      cachedProfile = await liff.getProfile();
      log("âœ… userId: " + cachedProfile.userId);
      log("âœ… name: " + cachedProfile.displayName);
    }

    async function postOne(i) {
      const prefix = document.getElementById("prefix").value.trim() || "lock-test";
      const now = new Date();
      const tag = `${prefix}-${now.toISOString()}-#${i}`;

      const payload = {
        userId: cachedProfile?.userId || "",
        content: tag
      };

      const t0 = performance.now();
      const res = await fetch(GAS_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload),
      });
      const text = await res.text();
      const t1 = performance.now();

      return { i, tag, ok: res.ok, text, ms: Math.round(t1 - t0) };
    }

    async function burst10() {
      if (!cachedProfile) {
        log("âš ï¸ å…ˆæŒ‰ Init LIFFï¼ˆæˆ–ç¢ºèªå·²ç™»å…¥ï¼‰");
        return;
      }

      log("ğŸš€ é–‹å§‹ä¸¦ç™¼é€å‡º 10 ç­†...");
      const jobs = [];
      for (let i = 1; i <= 10; i++) jobs.push(postOne(i));

      const results = await Promise.allSettled(jobs);

      log("âœ… å®Œæˆï¼Œçµæœå¦‚ä¸‹ï¼š");
      results.forEach(r => {
        if (r.status === "fulfilled") {
          const x = r.value;
          log(`- #${x.i} ${x.text} (${x.ms}ms) | ${x.tag}`);
        } else {
          log(`- âŒ rejected: ${r.reason}`);
        }
      });

      log("ğŸ‘‰ è«‹åˆ° Google Sheet çœ‹æ˜¯å¦æ–°å¢ 10 åˆ—ï¼Œä¸” content æ¬„ä½æœ‰ 10 å€‹ä¸åŒ tagã€‚");
    }

    document.getElementById("btnInit").addEventListener("click", () => {
      initLiff().catch(err => log("âŒ init error: " + err));
    });

    document.getElementById("btnBurst").addEventListener("click", () => {
      burst10().catch(err => log("âŒ burst error: " + err));
    });

    document.getElementById("btnClear").addEventListener("click", () => {
      logEl.textContent = "";
    });
  </script>
</body>
</html>
