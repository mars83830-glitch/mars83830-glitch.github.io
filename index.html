<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>æ¡ƒåœ’ç‡Ÿé‹è™•ï½œæ‰“å¡ç³»çµ±</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#fff;
      --shadow:0 10px 25px rgba(0,0,0,.06);
      --radius:18px;

      /* å­—é«” */
      --fs-title: 24px;
      --fs-sub: 16px;
      --fs-group: 32px;
      --fs-btn: 30px;
      --fs-status: 16px;
      --fs-debug: 13px;

      /* é¡è‰²ï¼šåˆ°ç«™æ·ºï¼ˆé»‘å­—ï¼‰ã€é›¢ç«™æ·±ï¼ˆç™½å­—ï¼‰ */
      --dispatch-light:#5fd49a;
      --dispatch-dark:#15905a;
      --level1-light:#ffbe5c;
      --level1-dark:#e07a00;
      --swap-light:#7fb2ff;
      --swap-dark:#1e79ff;
    }

    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Arial, "Noto Sans TC", sans-serif;
      background:var(--bg);
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      font-size: 18px;
    }

    .page{
      min-height: 100dvh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      box-sizing:border-box;
    }

    .card{
      width:min(560px, 100%);
      background:var(--card);
      border-radius:var(--radius);
      padding:20px;
      box-shadow:var(--shadow);
      box-sizing:border-box;
    }

    .title{
      font-size:var(--fs-title);
      font-weight:900;
      margin:0 0 10px;
      text-align:left;
      letter-spacing:.2px;
    }

    .sub{
      font-size:var(--fs-sub);
      color:#666;
      margin:0 0 16px;
      line-height:1.65;
    }

    /* æ¯å€‹é …ç›®ä¸€å¼µå¡ */
    .group{
      margin-bottom: 22px;
      border: 2px solid #e9edf5;
      border-radius: 18px;
      padding: 18px;
      background: #fff;
      box-shadow: 0 6px 16px rgba(0,0,0,.04);
    }
    .group:last-child{ margin-bottom: 0; }

    .groupTitle{
      font-size: var(--fs-group);
      font-weight: 900;
      color:#111;
      margin: 0 0 14px;
      line-height: 1.1;
    }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    button{
      border:0;
      border-radius:16px;
      padding: 18px 14px;
      font-size:var(--fs-btn);
      font-weight:900;
      cursor:pointer;
      width:100%;
    }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    /* åˆ°ç«™ï¼šæ·ºè‰² + é»‘å­— */
    .dispatchArrive{ background: var(--dispatch-light); color:#000; }
    .level1Arrive{ background: var(--level1-light); color:#000; }
    .swapArrive{ background: var(--swap-light); color:#000; }

    /* é›¢ç«™ï¼šæ·±è‰² + ç™½å­— */
    .dispatchLeave{ background: var(--dispatch-dark); color:#fff; }
    .level1Leave{ background: var(--level1-dark); color:#fff; }
    .swapLeave{ background: var(--swap-dark); color:#fff; }

    .status{
      margin-top:16px;
      font-size:var(--fs-status);
      line-height:1.7;
      white-space:pre-wrap;
      min-height: 22px;
    }
    .ok{ color:#0a7a35; font-weight:900; }
    .err{ color:#b42318; font-weight:900; }
    .muted{ color:#666; }

    /* âœ… é–’ç½®æé†’å€ */
    .idleWrap{
      display:none;
      margin-top:12px;
      border:2px dashed #e5e7eb;
      border-radius:16px;
      padding:12px;
      background:#fff;
    }
    .idleTitle{
      font-weight:900;
      margin:0 0 6px;
      color:#111;
    }
    .idleText{
      margin:0 0 10px;
      color:#666;
      font-size:14px;
      line-height:1.5;
    }
    .idleBtn{
      font-size:16px;
      font-weight:900;
      padding:12px 14px;
      border-radius:14px;
      border:0;
      width:auto;
      color:#fff;
      background:#111;
      cursor:pointer;
    }

    /* âœ… å¯é¸æ‹ç…§å€ */
    .photoWrap{
      display:none;
      margin-top:12px;
      border:2px solid #e5e7eb;
      border-radius:16px;
      padding:12px;
      background:#fff;
    }
    .photoTitle{
      font-weight:900;
      margin:0 0 6px;
      color:#111;
    }
    .photoText{
      margin:0 0 10px;
      color:#666;
      font-size:14px;
      line-height:1.5;
      white-space:pre-wrap;
    }
    .photoRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .photoBtn{
      font-size:18px;
      font-weight:900;
      padding:12px 10px;
      border-radius:14px;
      width:100%;
    }
    .photoTake{
      background:#111;
      color:#fff;
      border:0;
    }
    .photoSkip{
      background:#fff;
      color:#666;
      border:2px solid #d1d5db;
    }
    .photoHint{
      margin-top:8px;
      color:#666;
      font-size:12px;
      line-height:1.4;
    }

    details{ margin-top:14px; }
    summary{ cursor:pointer; color:#666; font-size:14px; }
    .debugBox{
      margin-top:10px;
      border:1px solid #e5e7eb;
      border-radius:14px;
      padding:12px;
      background:#fafafa;
      font-size:var(--fs-debug);
      max-height: 240px;
      overflow:auto;
      white-space:pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="card">
      <p class="title">æ¡ƒåœ’ç‡Ÿé‹è™•ï½œæ‰“å¡ç³»çµ±</p>
      <p class="sub">
        é¸æ“‡ä½œæ¥­é¡ï¼Œé»é¸ã€Œåˆ°ç«™ã€æˆ–ã€Œé›¢ç«™ã€æ‰“å¡<br>
        æˆåŠŸå¾Œå¯é¸æ“‡æ‹ç…§ä¸Šå‚³ï¼ˆä¸å½±éŸ¿æ‰“å¡ï¼‰ã€‚
      </p>

      <div class="group">
        <div class="groupTitle">èª¿åº¦</div>
        <div class="row2">
          <button id="btnDispatchArrive" class="dispatchArrive">åˆ°ç«™æ‰“å¡</button>
          <button id="btnDispatchLeave" class="dispatchLeave">é›¢ç«™æ‰“å¡</button>
        </div>
      </div>

      <div class="group">
        <div class="groupTitle">ä¸€ç´š</div>
        <div class="row2">
          <button id="btnLevel1Arrive" class="level1Arrive">åˆ°ç«™æ‰“å¡</button>
          <button id="btnLevel1Leave" class="level1Leave">é›¢ç«™æ‰“å¡</button>
        </div>
      </div>

      <div class="group">
        <div class="groupTitle">æ›é›»</div>
        <div class="row2">
          <button id="btnSwapArrive" class="swapArrive">åˆ°ç«™æ‰“å¡</button>
          <button id="btnSwapLeave" class="swapLeave">é›¢ç«™æ‰“å¡</button>
        </div>
      </div>

      <!-- âœ… é–’ç½®æé†’ï¼ˆæ›å¤ªä¹…è‡ªæ•‘ï¼‰ -->
      <div id="idleWrap" class="idleWrap">
        <p class="idleTitle">é é¢å·²ä¹…æœªæ“ä½œ</p>
        <p class="idleText">è‹¥ä½ æŠŠæ‰“å¡é é¢æ”¾å¤ªä¹…ï¼ŒLINE/å®šä½å¯èƒ½æœƒå¤±æ•ˆï¼Œå®¹æ˜“å‡ºç¾ã€Œæ‰“å¡å¤±æ•—ã€ã€‚å»ºè­°æŒ‰ä¸‹é‡æ–°æ•´ç†å†æ‰“å¡ã€‚</p>
        <button class="idleBtn" onclick="hardReload()">é‡æ–°æ•´ç†</button>
      </div>

      <!-- âœ… ç‹€æ…‹è¨Šæ¯ -->
      <div id="status" class="status muted"></div>

      <!-- âœ… æ‰“å¡æˆåŠŸå¾Œé¡¯ç¤ºï¼šå¯é¸æ‹ç…§ -->
      <div id="photoWrap" class="photoWrap">
        <p class="photoTitle">ğŸ“· å¯é¸ï¼šæ‹ç…§ä¸Šå‚³ç«™é»ç…§ç‰‡</p>
        <p id="photoText" class="photoText">æ‰“å¡å·²å®Œæˆï¼Œå¯æ‹ç…§è£œå……ç¾å ´ç´€éŒ„ï¼ˆä¸å½±éŸ¿æ‰“å¡ï¼‰ã€‚</p>
        <div class="photoRow">
          <button id="btnTakePhoto" class="photoBtn photoTake" type="button">æ‹ç…§ä¸Šå‚³</button>
          <button id="btnSkipPhoto" class="photoBtn photoSkip" type="button">ç•¥éä¸¦é—œé–‰</button>
        </div>
        <div class="photoHint">â€» ç³»çµ±æœƒå„ªå…ˆé–‹å•Ÿç›¸æ©Ÿï¼›éƒ¨åˆ†æ‰‹æ©Ÿ/LINEç‰ˆæœ¬ä»å¯èƒ½é¡¯ç¤ºç›¸ç°¿é¸é …ã€‚</div>
      </div>

      <!-- éš±è—æª”æ¡ˆè¼¸å…¥ï¼šå„ªå…ˆå¾Œé¡é ­ -->
      <input id="photoInput" type="file" accept="image/*" capture="environment" style="display:none">

      <details id="dbgWrap" style="display:none;">
        <summary>debugï¼ˆåƒ… test=1 é¡¯ç¤ºï¼‰</summary>
        <div id="debug" class="debugBox"></div>
      </details>
    </div>
  </div>

<script>
/** ===== åªè¦ç¢ºèªé€™å…©å€‹ ===== */
const LIFF_ID = "2009174277-dSY24pNu";
const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyI1gsHWcdfnynjPyuJ55VRFLiwq74ULORIvRHHc94VA0PN673AVtWF6UC_0t5Ch_Ki/exec";

/** âœ… é–’ç½®è¶…éå¹¾åˆ†é˜å°±æé†’ï¼ˆå¯èª¿æ•´ï¼‰ */
const IDLE_WARN_MIN = 8;

/** âœ… å®šä½ç­–ç•¥ï¼ˆæ›´å¿«æ›´ç©©ï¼‰ */
const GEO_OPTIONS = {
  enableHighAccuracy: false,
  timeout: 8000,
  maximumAge: 15000
};

/** ===== UI ===== */
const $status = document.getElementById("status");
const $debug = document.getElementById("debug");
const $dbgWrap = document.getElementById("dbgWrap");
const $idleWrap = document.getElementById("idleWrap");

const $photoWrap = document.getElementById("photoWrap");
const $photoText = document.getElementById("photoText");
const $photoInput = document.getElementById("photoInput");
const $btnTakePhoto = document.getElementById("btnTakePhoto");
const $btnSkipPhoto = document.getElementById("btnSkipPhoto");

const btns = {
  dispatchArrive: document.getElementById("btnDispatchArrive"),
  dispatchLeave:  document.getElementById("btnDispatchLeave"),
  level1Arrive:   document.getElementById("btnLevel1Arrive"),
  level1Leave:    document.getElementById("btnLevel1Leave"),
  swapArrive:     document.getElementById("btnSwapArrive"),
  swapLeave:      document.getElementById("btnSwapLeave"),
};

function setStatus(msg, type){
  $status.className = "status " + (type === "ok" ? "ok" : type === "err" ? "err" : "muted");
  $status.textContent = msg || "";
}
function setButtonsDisabled(disabled){
  Object.values(btns).forEach(b => b.disabled = disabled);
}
function setPhotoWrapVisible(show){
  $photoWrap.style.display = show ? "" : "none";
}
function setPhotoButtonsDisabled(disabled){
  $btnTakePhoto.disabled = disabled;
  $btnSkipPhoto.disabled = disabled;
}

/** ===== æœ¬æ¬¡æ‰“å¡çµæœï¼ˆä¾›ç…§ç‰‡ä¸Šå‚³ç¶å®šï¼‰ ===== */
let lastPunch = null; 
// { recordKey, row, step, job, stationName, uid, displayName, lineIdToWrite }

/** ===== è§£æåƒæ•¸ï¼šä¸€èˆ¬ query + liff.state ===== */
function getMergedParams(){
  const normal = new URLSearchParams(window.location.search || "");
  const merged = new URLSearchParams(normal.toString());

  const stateRaw = normal.get("liff.state");
  if (stateRaw) {
    let decoded = "";
    try { decoded = decodeURIComponent(stateRaw); } catch(e){ decoded = stateRaw; }
    if (decoded.startsWith("?")) decoded = decoded.slice(1);
    const sp = new URLSearchParams(decoded);
    for (const [k,v] of sp.entries()) merged.set(k,v);
  }
  return merged;
}
function isTestMode(){
  const p = getMergedParams();
  return p.get("test") === "1";
}
function showDebug(obj){
  if (!isTestMode()) return;
  $dbgWrap.style.display = "";
  $debug.textContent = JSON.stringify(obj, null, 2);
}

/** ===== æ–‡å­— ===== */
function jobCN(job){
  return job === "dispatch" ? "èª¿åº¦"
       : job === "level1" ? "ä¸€ç´š"
       : job === "swap" ? "æ›é›»"
       : job;
}
function stepCN(step){
  return step === "arrive" ? "åˆ°ç«™" : "é›¢ç«™";
}

/** ===== é–’ç½®è‡ªæ•‘ ===== */
let lastActionAt = Date.now();
let idleShown = false;

function touchAction(){
  lastActionAt = Date.now();
  if (idleShown) {
    $idleWrap.style.display = "none";
    idleShown = false;
  }
}
function hardReload(){
  try {
    const url = new URL(location.href);
    url.searchParams.set("v", String(Date.now()));
    location.replace(url.toString());
  } catch(_) {
    location.reload(true);
  }
}
setInterval(() => {
  const idleMin = (Date.now() - lastActionAt) / 60000;
  if (idleMin >= IDLE_WARN_MIN && !idleShown) {
    idleShown = true;
    $idleWrap.style.display = "";
  }
}, 15000);

/** ===== å®šä½ ===== */
function getLocation(){
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) return reject(new Error("æ­¤è£ç½®ä¸æ”¯æ´å®šä½"));
    navigator.geolocation.getCurrentPosition(
      (pos) => resolve({
        lat: pos.coords.latitude,
        lng: pos.coords.longitude,
        accuracy: pos.coords.accuracy
      }),
      (err) => reject(new Error(err.message || "å®šä½å¤±æ•—")),
      GEO_OPTIONS
    );
  });
}

/** ===== LIFF profileï¼ˆåŠ å¼·ç‰ˆï¼Œå¤±æ•ˆæ™‚æç¤ºï¼‰ ===== */
async function getProfileSafe(){
  await liff.init({ liffId: LIFF_ID });

  if (!liff.isInClient() && !liff.isLoggedIn()) {
    liff.login();
    throw new Error("redirect_login");
  }

  try {
    return await liff.getProfile();
  } catch (e) {
    throw new Error("liff_profile_failed");
  }
}

/** ===== åœ–ç‰‡å£“ç¸®å·¥å…· ===== */
function fileToImage(file){
  return new Promise((resolve, reject) => {
    const fr = new FileReader();
    fr.onload = () => {
      const img = new Image();
      img.onload = () => resolve(img);
      img.onerror = () => reject(new Error("åœ–ç‰‡è®€å–å¤±æ•—"));
      img.src = fr.result;
    };
    fr.onerror = () => reject(new Error("æª”æ¡ˆè®€å–å¤±æ•—"));
    fr.readAsDataURL(file);
  });
}
function canvasToBlob(canvas, type, quality){
  return new Promise((resolve, reject) => {
    canvas.toBlob((blob) => {
      if (!blob) return reject(new Error("åœ–ç‰‡å£“ç¸®å¤±æ•—"));
      resolve(blob);
    }, type, quality);
  });
}
async function compressImageFile(file, maxEdge = 1280, quality = 0.75){
  const img = await fileToImage(file);
  let w = img.naturalWidth || img.width;
  let h = img.naturalHeight || img.height;
  if (!w || !h) throw new Error("åœ–ç‰‡å°ºå¯¸ç„¡æ•ˆ");

  const scale = Math.min(1, maxEdge / Math.max(w, h));
  const tw = Math.max(1, Math.round(w * scale));
  const th = Math.max(1, Math.round(h * scale));

  const canvas = document.createElement("canvas");
  canvas.width = tw;
  canvas.height = th;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(img, 0, 0, tw, th);

  return await canvasToBlob(canvas, "image/jpeg", quality);
}
function blobToBase64(blob){
  return new Promise((resolve, reject) => {
    const fr = new FileReader();
    fr.onload = () => {
      const result = String(fr.result || "");
      const base64 = result.includes(",") ? result.split(",")[1] : result;
      resolve(base64);
    };
    fr.onerror = () => reject(new Error("åœ–ç‰‡è½‰æª”å¤±æ•—"));
    fr.readAsDataURL(blob);
  });
}

/** ===== å…±ç”¨ POST ===== */
async function postJSON(payload){
  const res = await fetch(GAS_WEB_APP_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(payload),
  });

  const text = await res.text();
  let data = {};
  try { data = JSON.parse(text); } catch(_) {}
  return { res, text, data };
}

/** ===== æ‰“å¡ ===== */
async function punch(job, step){
  touchAction();
  setButtonsDisabled(true);
  setPhotoWrapVisible(false);
  lastPunch = null;

  setStatus(`å®šä½ä¸­â€¦ï¼ˆ${jobCN(job)}ï½œ${stepCN(step)}ï¼‰`, "muted");

  const params = getMergedParams();
  const bypassKey = params.get("key") || "";
  const v = params.get("v") || "";
  const test = params.get("test") || "";

  try{
    const profile = await getProfileSafe();
    const loc = await getLocation();

    setStatus("é€å‡ºæ‰“å¡â€¦", "muted");

    const payload = {
      action: "punch",
      job,
      step,
      userId: profile.userId || "",
      displayName: profile.displayName || "",
      lat: loc.lat,
      lng: loc.lng,
      accuracy: loc.accuracy,
      bypassKey,
      test,
      v,
      href: location.href,
      ts: Date.now()
    };

    showDebug({ step:"request_punch", payload });

    const { res, text, data } = await postJSON(payload);
    showDebug({ step:"response_punch", status: res.status, text, data });

    if (!data.ok) {
      const msg = data.message || "æ‰“å¡å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
      if (msg.includes("é›¢å ´ç«™éé ") || msg.includes("å°šæœªåˆ°ç«™") || msg.includes("åŒä¸€ç«™é»")) {
        setStatus(`éŒ¯èª¤ï¼š${msg}`, "err");
      } else {
        setStatus(`éŒ¯èª¤ï¼š${msg}\nï¼ˆè‹¥é é¢æ”¾å¤ªä¹…ï¼Œå»ºè­°æŒ‰ä¸‹é‡æ–°æ•´ç†å†è©¦ï¼‰`, "err");
        $idleWrap.style.display = "";
        idleShown = true;
      }
      setButtonsDisabled(false);
      return;
    }

    const station = data.stationName ? `\nç«™é»ï¼š${data.stationName}` : "";
    setStatus(`å®Œæˆ âœ…\n${jobCN(job)}ï½œ${stepCN(step)}æ‰“å¡${station}`, "ok");

    // å„²å­˜é€™æ¬¡æ‰“å¡è³‡è¨Šï¼Œä¾›ç…§ç‰‡ä¸Šå‚³ç¶å®š
    lastPunch = {
      recordKey: data.recordKey || "",
      row: data.row || "",
      step: data.step || step,
      job: data.jobRaw || job,
      stationName: data.stationName || "",
      uid: data.uid || (profile.userId || ""),
      displayName: profile.displayName || "",
      lineIdToWrite: data.lineIdToWrite || (profile.displayName || profile.userId || "TEST")
    };

    // é¡¯ç¤ºå¯é¸æ‹ç…§å€ï¼ˆä¸å¼·åˆ¶ï¼‰
    $photoText.textContent = `æ‰“å¡å·²å®Œæˆï¼ˆ${jobCN(job)}ï½œ${stepCN(step)}ï¼‰${data.stationName ? "ï¼Œç«™é»ï¼š" + data.stationName : ""}ã€‚\nå¯é¸æ“‡æ‹ç…§ä¸Šå‚³ä½œç‚ºç´€éŒ„ï¼ˆä¸å½±éŸ¿æ‰“å¡ï¼‰ã€‚`;
    setPhotoWrapVisible(true);
    setPhotoButtonsDisabled(false);

  } catch(e){
    const msg = (e && e.message) ? e.message : String(e);

    if (msg === "redirect_login") {
      setButtonsDisabled(false);
      return;
    }

    if (!isTestMode()) {
      if (msg === "liff_profile_failed") {
        setStatus("éŒ¯èª¤ï¼šé é¢å·²æ”¾ç½®éä¹…ï¼Œè«‹é‡æ–°æ•´ç†å¾Œå†æ‰“å¡", "err");
        $idleWrap.style.display = "";
        idleShown = true;
      } else if (msg.toLowerCase().includes("timeout")) {
        setStatus("éŒ¯èª¤ï¼šå®šä½é€¾æ™‚ï¼Œè«‹é–‹å•Ÿå®šä½æˆ–é‡æ–°æ•´ç†å¾Œå†è©¦", "err");
      } else {
        setStatus("éŒ¯èª¤ï¼šæ‰“å¡å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦\nï¼ˆè‹¥é é¢æ”¾å¤ªä¹…ï¼Œå»ºè­°é‡æ–°æ•´ç†ï¼‰", "err");
        $idleWrap.style.display = "";
        idleShown = true;
      }
    } else {
      setStatus(`éŒ¯èª¤ï¼š${msg}`, "err");
      showDebug({ step:"catch_punch", error: String(e), stack: e && e.stack ? e.stack : "" });
      $idleWrap.style.display = "";
      idleShown = true;
    }

    setButtonsDisabled(false);
  }
}

/** ===== æ‹ç…§ä¸Šå‚³ï¼ˆå¯é¸ï¼‰ ===== */
$btnTakePhoto.addEventListener("click", () => {
  touchAction();
  if (!lastPunch || !lastPunch.recordKey) {
    setStatus("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°æœ¬æ¬¡æ‰“å¡ç´€éŒ„ï¼Œè«‹é‡æ–°æ‰“å¡", "err");
    return;
  }
  $photoInput.value = "";
  $photoInput.click();
});

$btnSkipPhoto.addEventListener("click", () => {
  touchAction();
  setPhotoButtonsDisabled(true);
  setStatus(($status.textContent || "å®Œæˆ âœ…") + "\nï¼ˆå·²ç•¥éç…§ç‰‡ï¼‰", "ok");
  setTimeout(() => {
    try { liff.closeWindow(); } catch(_) {}
  }, 700);
});

$photoInput.addEventListener("change", async (ev) => {
  touchAction();
  const file = ev.target.files && ev.target.files[0];
  if (!file) return;

  if (!lastPunch || !lastPunch.recordKey) {
    setStatus("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°æœ¬æ¬¡æ‰“å¡ç´€éŒ„ï¼Œè«‹é‡æ–°æ‰“å¡", "err");
    setPhotoButtonsDisabled(false);
    return;
  }

  try {
    setPhotoButtonsDisabled(true);
    setStatus("ç…§ç‰‡è™•ç†ä¸­â€¦", "muted");

    const compressed = await compressImageFile(file, 1280, 0.75);
    const imageBase64 = await blobToBase64(compressed);

    const params = getMergedParams();
    const test = params.get("test") || "";
    const bypassKey = params.get("key") || "";

    const payload = {
      action: "uploadPhoto",
      recordKey: lastPunch.recordKey,
      uid: lastPunch.uid || "",
      job: lastPunch.job || "",
      step: lastPunch.step || "",
      stationName: lastPunch.stationName || "",
      displayName: lastPunch.displayName || "",
      lineIdToWrite: lastPunch.lineIdToWrite || "",
      mimeType: "image/jpeg",
      fileName: `${stepCN(lastPunch.step)}_${jobCN(lastPunch.job)}_${Date.now()}.jpg`,
      imageBase64,
      test,
      bypassKey,
      ts: Date.now()
    };

    showDebug({
      step: "request_upload_photo",
      payload: {
        ...payload,
        imageBase64: `<<base64 ${imageBase64.length} chars>>`
      }
    });

    const { res, text, data } = await postJSON(payload);
    showDebug({ step:"response_upload_photo", status: res.status, text, data });

    if (!data.ok) {
      const msg = data.message || "ç…§ç‰‡ä¸Šå‚³å¤±æ•—";
      setStatus(`å®Œæˆ âœ…ï¼ˆæ‰“å¡å·²æˆåŠŸï¼‰\nç…§ç‰‡ä¸Šå‚³å¤±æ•—ï¼š${msg}\nå¯é‡è©¦æˆ–ç•¥é`, "err");
      setPhotoButtonsDisabled(false);
      return;
    }

    setStatus(`å®Œæˆ âœ…\nç…§ç‰‡å·²ä¸Šå‚³`, "ok");
    setPhotoButtonsDisabled(true);

    setTimeout(() => {
      try { liff.closeWindow(); } catch(_) {}
    }, 700);

  } catch (e) {
    const msg = (e && e.message) ? e.message : String(e);
    if (!isTestMode()) {
      setStatus("å®Œæˆ âœ…ï¼ˆæ‰“å¡å·²æˆåŠŸï¼‰\nç…§ç‰‡ä¸Šå‚³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–ç•¥é", "err");
    } else {
      setStatus(`å®Œæˆ âœ…ï¼ˆæ‰“å¡å·²æˆåŠŸï¼‰\nç…§ç‰‡ä¸Šå‚³å¤±æ•—ï¼š${msg}`, "err");
      showDebug({ step:"catch_upload_photo", error: String(e), stack: e && e.stack ? e.stack : "" });
    }
    setPhotoButtonsDisabled(false);
  }
});

/** ç¶å®šï¼šä¸‰ä½œæ¥­ Ã— åˆ°ç«™/é›¢ç«™ */
btns.dispatchArrive.addEventListener("click", () => punch("dispatch","arrive"));
btns.dispatchLeave.addEventListener("click", () => punch("dispatch","leave"));

btns.level1Arrive.addEventListener("click", () => punch("level1","arrive"));
btns.level1Leave.addEventListener("click", () => punch("level1","leave"));

btns.swapArrive.addEventListener("click", () => punch("swap","arrive"));
btns.swapLeave.addEventListener("click", () => punch("swap","leave"));

/** åˆå§‹ï¼ˆä¸é¡¯ç¤ºå•Ÿå‹•ä¸­æ–‡å­—ï¼‰ */
(function(){
  document.addEventListener("click", touchAction, { passive:true });
  document.addEventListener("touchstart", touchAction, { passive:true });
  document.addEventListener("keydown", touchAction, { passive:true });

  if (isTestMode()) {
    const p = getMergedParams();
    showDebug({ note:"test=1", mergedParams:Object.fromEntries(p.entries()) });
  } else {
    setStatus("", "muted");
  }
})();
</script>
</body>
</html>
